import yt_dlp
from tiktok_downloader import ttdownloader
from utils.logging import log_error
import os
from utils.random_filename import uuid_filename
import requests
from bs4 import BeautifulSoup
from utils.pinterest import download_pin
import re

def register_handlers(bot):
    @bot.message_handler(func=lambda message: True)
    def handle_message(message):
        try:
            if message.text == 'üì∫YouTube' or message.text == 'YouTube':
                bot.send_message(message.chat.id, "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ Youtube")
            elif message.text == 'üì∫TikTok' or message.text == 'TikTok':
                bot.send_message(message.chat.id, "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–ª–∏–ø TikTok")
            elif message.text == 'üì∫Pinterest' or message.text == 'Pinterest':
                bot.send_message(message.chat.id, "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ Pinterest")
            elif message.text == 'üì∫Pinterest GIF' or message.text == 'Pinterest GIF':
                gif = bot.send_message(message.chat.id, "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ GIF Pinterest")
                bot.register_next_step_handler(gif, download_pinterest_gif)
            elif message.text == '‚ùìFAQ' or message.text == 'FAQ':
                with open('faq.txt', 'r') as file:
                    text = file.read()
                    bot.send_message(message.chat.id, text)
            elif message.text == 'üì§–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ' or message.text == '–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ':
                bot.send_message(message.chat.id, "–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞, –ø—Ä–æ—à—É —Å–æ–æ–±—â–∏—Ç—å –æ–± —ç—Ç–æ–º –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞: @a4ivi4")
            elif 'youtube.com' in message.text or 'youtu.be' in message.text:
                url = message.text
                ytfilename = uuid_filename + '.mp4'
                if 'youtube.com' in url or 'youtu.be' in url:
                    ydl_opts = {
                        'format': 'bestvideo[ext=mp4][vcodec=h264]+bestaudio[ext=m4a]/best[ext=mp4][vcodec=h264]/best[ext=mp4]/best',
                        'outtmpl': ytfilename,
                    }
                    try:
                        url_allow = url
                        bot.send_chat_action(message.chat.id, 'upload_video')
                        ydl = yt_dlp.YoutubeDL(ydl_opts)
                        info = ydl.extract_info(url_allow, download=True)
                        with open(ytfilename, "rb") as file:
                            bot.send_video(message.chat.id, file, timeout=240)
                        bot.reply_to(message, '–í–∏–¥–µ–æ –∏–∑ YouTube —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ')
                        os.remove(ytfilename)

                    except Exception as e:
                        bot.reply_to(message, f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ: {e}')
                        os.remove(ytfilename)
                else:
                    bot.reply_to(message, '–°—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É')
            elif 'tiktok.com' in message.text:
                url = message.text
                filename = uuid_filename + '.mp4'
                if 'tiktok.com' in url:
                    try:
                        bot.send_chat_action(message.chat.id, 'upload_video')
                        d = ttdownloader(url)
                        d[0].download(filename)
                        with open(filename, 'rb') as file:
                            bot.send_video(message.chat.id, file)
                        bot.reply_to(message, '–í–∏–¥–µ–æ –∏–∑ TikTok —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ')
                        os.remove(filename)
                    except Exception as e:
                        bot.reply_to(message, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ')
                        print(e)
                        os.remove(filename)
                else:
                    bot.reply_to(message, '–°—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É')
            elif 'pin.it' in message.text:
                try:
                    url = message.text
                    bot.send_chat_action(message.chat.id, 'upload_video')
                    if("https://pin.it/" in url): 
                        t_body = requests.get(url)
                        if(t_body.status_code!= 200):
                            bot.reply_to(message, "–í–≤–µ–¥–µ–Ω–Ω—ã–π URL –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
                            return
                        soup = BeautifulSoup(t_body.content,"html.parser")
                        href_link = (soup.find("link",rel="alternate"))['href']
                        match = re.search('url=(.*?)&', href_link)
                        url = match.group(1) 
                    body = requests.get(url) 
                    if(body.status_code!= 200): 
                        bot.reply_to(message, "–í–≤–µ–¥–µ–Ω–Ω—ã–π URL –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
                        return
                    soup = BeautifulSoup(body.content, "html.parser") 
                    extract_url = (soup.find("video",class_="hwa kVc MIw L4E"))['src'] 
                    convert_url = extract_url.replace("hls","720p").replace("m3u8","mp4")
                    filename = uuid_filename +".mp4"
                    download_pin(convert_url, filename)
                    with open(filename, 'rb') as file:
                        bot.send_video(message.chat.id, file)
                    bot.reply_to(message, '–í–∏–¥–µ–æ –∏–∑ Pinterest —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ')
                    os.remove(filename)
                except Exception as e:
                    log_error(e)
                    bot.reply_to(message, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ')
        except Exception as e:
            log_error(e)
            bot.reply_to(message, f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ')
    
    def download_pinterest_gif(message):
        pinterest_url = message.text
        response = requests.get(pinterest_url)
        soup = BeautifulSoup(response.text, 'html.parser')
        images = soup.find_all('img')
        gifs = soup.find_all('video')
        media_files = []
        for img in images:
            img_url = img.get('src')
            if img_url:
                media_files.append(img_url)
        for gif in gifs:
            gif_url = gif.get('src')
            if gif_url:
                media_files.append(gif_url)
        for file in media_files:
            response = requests.get(file, stream=True)
            file_name = os.path.basename(file)
            with open(file_name, 'wb') as f:
                for chunk in response.iter_content(1024):
                    f.write(chunk)
            bot.send_document(message.chat.id, open(file_name, 'rb'))